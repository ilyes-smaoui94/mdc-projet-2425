import java.util.Set;
import java.util.HashSet;
import java.util.Arrays;
import java.util.List;
import java.util.ArrayList;
import java.util.Date;

/**
 * Implémentation de l'interface {@link IModeleCinema} pour gérer le modèle d'un cinéma.
 * <p>
 * Cette classe gère les utilisateurs, les films, les salles, les séances, les billets et les réservations.
 * Chaque entité est stockée dans une collection type {@code Set}.
 * </p>
 * <p>
 * Chaque méthode est conçue pour capturer les exception etretourne en cas d'erreur,
 *  une valeur par défaut, la constante {@link #ID_VALUE_ON_ERROR} (-1) pour les méthodes
 * retournant un entier ou {@code false} pour les méthodes retournant un booléen.
 * </p>
 * <p>
 *  le champ {@code utilisateurConnecte} représente l'utilisateur actuellement connecté.
 * </p>
 */
public class ModeleCinema implements IModeleCinema {

    /** L'utilisateur actuellement connecté. */
    private Utilisateur utilisateurConnecte;
    /** Ensemble des utilisateurs enregistrés. */
    private Set<Utilisateur> utilisateursEnregistres;
    /** Ensemble des emails des utilisateurs enregistrés (pour éviter les doublons). */
    private Set<String> emailsUtilisateursEnregistres;
    /** Ensemble des films enregistrés. */
    private Set<Film> filmsEnregistres;
    /** Ensemble des salles enregistrées. */
    private Set<Salle> sallesEnregistrees;
    /** Ensemble des séances enregistrées. */
    private Set<Seance> seancesEnregistrees;
    /** Ensemble des billets enregistrés. */
    private Set<Billet> billetsEnregistres;
    /** Ensemble des réservations enregistrées. */
    private Set<Reservation> reservationsEnregistrees;

    /** Constante représentant la valeur d'erreur pour les méthodes retournant un int. */
    public static final int ID_VALUE_ON_ERROR = -1;

    /**
     * Constructeur de {@code ModeleCinema}.
     * <p>
     * Initialise les différentes collections utilisées pour stocker les entités du cinéma.
     * </p>
     */
    public ModeleCinema() {
        this.utilisateursEnregistres = new HashSet<Utilisateur>();
        this.emailsUtilisateursEnregistres = new HashSet<String>();
        this.filmsEnregistres = new HashSet<Film>();
        this.sallesEnregistrees = new HashSet<Salle>();
        this.seancesEnregistrees = new HashSet<Seance>();
        this.billetsEnregistres = new HashSet<Billet>();
        this.reservationsEnregistrees = new HashSet<Reservation>();
    }

    /**
     * Récupère l'utilisateur enregistré correspondant à l'ID fourni.
     *
     * @param id L'identifiant de l'utilisateur à récupérer.
     * @return L'instance de {@code Utilisateur} si trouvée, ou {@code null} sinon.
     */
    @Override
    public Utilisateur getUtilisateur(int id) {
        for (Utilisateur u : this.utilisateursEnregistres) {
            if (u.getId() == id) {
                return u;
            }
        }
        return null;
    }

    /**
     * Récupère le film enregistré correspondant à l'ID fourni.
     *
     * @param id L'identifiant du film à récupérer.
     * @return L'instance de {@code Film} si trouvée, ou {@code null} sinon.
     */
    @Override
    public Film getFilm(int id) {
        for (Film f : this.filmsEnregistres) {
            if (f.getId() == id) {
                return f;
            }
        }
        return null;
    }

    /**
     * Récupère la réservation enregistrée correspondant à l'ID fourni.
     *
     * @param id L'identifiant de la réservation à récupérer.
     * @return L'instance de {@code Reservation} si trouvée, ou {@code null} sinon.
     */
    @Override
    public Reservation getReservation(int id) {
        for (Reservation r : this.reservationsEnregistrees) {
            if (r.getId() == id) {
                return r;
            }
        }
        return null;
    }

    /**
     * Récupère le billet enregistré correspondant à l'ID fourni.
     *
     * @param id L'identifiant du billet à récupérer.
     * @return L'instance de {@code Billet} si trouvée, ou {@code null} sinon.
     */
    @Override
    public Billet getBillet(int id) {
        for (Billet b : this.billetsEnregistres) {
            if (b.getId() == id) {
                return b;
            }
        }
        return null;
    }

    /**
     * Récupère la salle enregistrée correspondant à l'ID fourni.
     *
     * @param id L'identifiant de la salle à récupérer.
     * @return L'instance de {@code Salle} si trouvée, ou {@code null} sinon.
     */
    @Override
    public Salle getSalle(int id) {
        for (Salle s : this.sallesEnregistrees) {
            if (s.getId() == id) {
                return s;
            }
        }
        return null;
    }

    /**
     * Récupère la séance enregistrée correspondant à l'ID fourni.
     *
     * @param id L'identifiant de la séance à récupérer.
     * @return L'instance de {@code Seance} si trouvée, ou {@code null} sinon.
     */
    @Override
    public Seance getSeance(int id) {
        for (Seance s : this.seancesEnregistrees) {
            if (s.getId() == id) {
                return s;
            }
        }
        return null;
    }

    /**
     * Retourne l'ensemble des utilisateurs enregistrés.
     *
     * @return Un {@code Set} contenant tous les utilisateurs enregistrés.
     */
    @Override
    public Set<Utilisateur> getListeUtilisateur() {
        return this.utilisateursEnregistres;
    }

    /**
     * Retourne l'ensemble des films enregistrés.
     *
     * @return Un {@code Set} contenant tous les films enregistrés.
     */
    @Override
    public Set<Film> getListeFilms() {
        return this.filmsEnregistres;
    }

    /**
     * Retourne l'ensemble des salles enregistrées.
     *
     * @return Un {@code Set} contenant toutes les salles enregistrées.
     */
    @Override
    public Set<Salle> getListeSalles() {
        return this.sallesEnregistrees;
    }

    /**
     * Retourne l'ensemble des séances enregistrées.
     *
     * @return Un {@code Set} contenant toutes les séances enregistrées.
     */
    @Override
    public Set<Seance> getListeSeances() {
        return this.seancesEnregistrees;
    }

    /**
     * Retourne l'ensemble des séances associées à un film donné.
     *
     * @param f Le film dont on souhaite obtenir les séances.
     * @return Un {@code Set} contenant les séances du film.
     */
    @Override
    public Set<Seance> getListeSeancesFilm(Film f) {
        Set<Seance> resSeances = new HashSet<Seance>();
        for (Seance s : this.seancesEnregistrees) {
            if (s.getFilm().getId() == f.getId()) {
                resSeances.add(s);
            }
        }
        return resSeances;
    }

    /**
     * Retourne l'ensemble des réservations enregistrées.
     *
     * @return Un {@code Set} contenant toutes les réservations enregistrées.
     */
    @Override
    public Set<Reservation> getListeReservations() {
        return this.reservationsEnregistrees;
    }

    /**
     * Retourne l'ensemble des billets enregistrés.
     *
     * @return Un {@code Set} contenant tous les billets enregistrés.
     */
    @Override
    public Set<Billet> getListeBillets() {
        return this.billetsEnregistres;
    }

    /**
     * Ajoute un nouveau client.
     *
     * @param nom Le nom du client à ajouter.
     * @param email L'adresse email du client.
     * @param mdp Le mot de passe du client.
     * @return L'ID du client créé en cas de succès, ou {@link #ID_VALUE_ON_ERROR} en cas d'erreur.
     */
    @Override
    public int ajouterClient(String nom, String email, String mdp) {
        try {
            Client nvClient = new Client(nom, email, mdp);
            if (nvClient == null) {
                return ID_VALUE_ON_ERROR;
            }
            this.utilisateursEnregistres.add(nvClient);
            return nvClient.getId();
        } catch (Exception e) {
            return ID_VALUE_ON_ERROR;
        }
    }

    /**
     * Ajoute un nouveau manager.
     *
     * @param nom Le nom du manager à ajouter.
     * @param email L'adresse email du manager.
     * @param mdp Le mot de passe du manager.
     * @return L'ID du manager créé en cas de succès, ou {@link #ID_VALUE_ON_ERROR} en cas d'erreur.
     */
    @Override
    public int ajouterManager(String nom, String email, String mdp) {
        try {
            Manager leManager = Manager.getManagerInstance(nom, email, mdp);
            if (leManager == null) {
                return ID_VALUE_ON_ERROR;
            } else {
                this.utilisateursEnregistres.add(leManager);
                return leManager.getId();
            }
        } catch (Exception e) {
            return ID_VALUE_ON_ERROR;
        }
    }

    /**
     * Supprime l'utilisateur ayant l'ID spécifié.
     *
     * @param id L'ID de l'utilisateur à supprimer.
     * @return {@code true} si la suppression a réussi, {@code false} sinon.
     */
    @Override
    public boolean supprimerUtilisateur(int id) {
        try {
            Utilisateur utilisateurAEnlever = null;
            for (Utilisateur u : this.utilisateursEnregistres) {
                if (u.getId() == id) {
                    utilisateurAEnlever = u;
                    break;
                }
            }
            if (utilisateurAEnlever == null) {
                return false;
            } else {
                this.utilisateursEnregistres.remove(utilisateurAEnlever);
                return true;
            }
        } catch (Exception e) {
            return false;
        }
    }

    /**
     * Ajoute un nouveau film.
     *
     * @param titre Le titre du film.
     * @param a L'année de sortie du film.
     * @param desc La description du film.
     * @return L'ID du film créé en cas de succès, ou {@link #ID_VALUE_ON_ERROR} en cas d'erreur.
     */
    @Override
    public int ajouterFilm(String titre, int a, String desc) {
        try {
            Film nvFilm = new Film(titre, a, desc);
            if (nvFilm == null) {
                return ID_VALUE_ON_ERROR;
            }
            this.filmsEnregistres.add(nvFilm);
            return nvFilm.getId();
        } catch (Exception e) {
            return ID_VALUE_ON_ERROR;
        }
    }

    /**
     * Ajoute un nouveau film avec les genres spécifiés.
     *
     * @param titre Le titre du film.
     * @param a L'année de sortie du film.
     * @param desc La description du film.
     * @param genres_str Une liste de genres sous forme de chaînes de caractères.
     * @return L'ID du film créé en cas de succès, ou {@link #ID_VALUE_ON_ERROR} en cas d'erreur.
     */
    @Override
    public int ajouterFilm(String titre, int a, String desc, ArrayList<String> genres_str) {
        try {
            Set<Genre> genresSet = new HashSet<Genre>();
            for (String g_str : genres_str) {
                for (Genre g : Genre.values()) {
                    if (g.name().equalsIgnoreCase(g_str)) {
                        genresSet.add(g);
                    }
                }
            }
            Film nvFilm = new Film(titre, a, desc, genresSet);
            if (nvFilm == null) {
                return ID_VALUE_ON_ERROR;
            } else {
                this.filmsEnregistres.add(nvFilm);
                return nvFilm.getId();
            }
        } catch (Exception e) {
            return ID_VALUE_ON_ERROR;
        }
    }

    /**
     * Supprime le film ayant l'ID spécifié.
     *
     * @param id L'ID du film à supprimer.
     * @return {@code true} si la suppression a réussi, {@code false} sinon.
     */
    @Override
    public boolean supprimerFilm(int id) {
        try {
            Film filmAEnlever = null;
            for (Film f : this.filmsEnregistres) {
                if (f.getId() == id) {
                    filmAEnlever = f;
                    break;
                }
            }
            if (filmAEnlever == null) {
                return false;
            } else {
                this.filmsEnregistres.remove(filmAEnlever);
                return true;
            }
        } catch (Exception e) {
            return false;
        }
    }

    /**
     * Ajoute une nouvelle salle.
     *
     * @param numero Le numéro de la salle.
     * @param capacite La capacité de la salle.
     * @return L'ID de la salle créée en cas de succès, ou {@link #ID_VALUE_ON_ERROR} en cas d'erreur.
     */
    @Override
    public int ajouterSalle(int numero, int capacite) {
        try {
            Salle s = new Salle(numero, capacite);
            if (s == null) {
                return ID_VALUE_ON_ERROR;
            } else {
                this.sallesEnregistrees.add(s);
                return s.getId();
            }
        } catch (Exception e) {
            return ID_VALUE_ON_ERROR;
        }
    }

    /**
     * Supprime la salle ayant l'ID spécifié.
     *
     * @param id L'ID de la salle à supprimer.
     * @return {@code true} si la suppression a réussi, {@code false} sinon.
     */
    @Override
    public boolean supprimerSalle(int id) {
        try {
            Salle salleAEnlever = null;
            for (Salle s : this.sallesEnregistrees) {
                if (s.getId() == id) {
                    salleAEnlever = s;
                    break;
                }
            }
            if (salleAEnlever == null) {
                return false;
            } else {
                this.sallesEnregistrees.remove(salleAEnlever);
                return true;
            }
        } catch (Exception e) {
            return false;
        }
    }

    /**
     * Ajoute une nouvelle séance.
     *
     * @param idSalle L'ID de la salle pour la séance.
     * @param idFilm L'ID du film pour la séance.
     * @param heureDebut La date et l'heure de début de la séance.
     * @return L'ID de la séance créée en cas de succès, ou {@link #ID_VALUE_ON_ERROR} en cas d'erreur.
     */
    @Override
    public int ajouterSeance(int idSalle, int idFilm, Date heureDebut) {
        try {
            Seance s = new Seance(this.getSalle(idSalle), this.getFilm(idFilm), heureDebut);
            if (s == null) {
                return ID_VALUE_ON_ERROR;
            } else {
                this.seancesEnregistrees.add(s);
                return s.getId();
            }
        } catch (Exception e) {
            return ID_VALUE_ON_ERROR;
        }
    }

    /**
     * Supprime la séance ayant l'ID spécifié.
     *
     * @param id L'ID de la séance à supprimer.
     * @return {@code true} si la suppression a réussi, {@code false} sinon.
     */
    @Override
    public boolean supprimerSeance(int id) {
        try {
            Seance seanceAEnlever = null;
            for (Seance s : this.seancesEnregistrees) {
                if (s.getId() == id) {
                    seanceAEnlever = s;
                    break;
                }
            }
            if (seanceAEnlever == null) {
                return false;
            } else {
                this.seancesEnregistrees.remove(seanceAEnlever);
                return true;
            }
        } catch (Exception e) {
            return false;
        }
    }

    /**
     * Crée une nouvelle réservation pour un utilisateur donné.
     * <p>
     * Les billets spécifiés sont ajoutés à la collection des billets enregistrés.
     * </p>
     *
     * @param idUtilisateur L'ID de l'utilisateur effectuant la réservation.
     * @param billetsAPrendre Un ensemble de billets à réserver (plusieurs billets pour une même séance sont possibles).
     * @return L'ID de la réservation créée en cas de succès, ou {@link #ID_VALUE_ON_ERROR} en cas d'erreur.
     */
    @Override
    public int creerReservation(int idUtilisateur, Set<Billet> billetsAPrendre) {
        try {
            Utilisateur uResa = this.getUtilisateur(idUtilisateur);
            if (uResa == null) {
                return ID_VALUE_ON_ERROR;
            }
            for (Billet b : billetsAPrendre) {
                if (b != null) {
                    this.billetsEnregistres.add(b);
                }
            }
            Reservation nvlReservation = new Reservation(uResa, billetsAPrendre);
            this.reservationsEnregistrees.add(nvlReservation);
            return nvlReservation.getId();
        } catch (Exception e) {
            return ID_VALUE_ON_ERROR;
        }
    }

    /**
     * Supprime la réservation ayant l'ID spécifié.
     * <p>
     * Les billets associés à la réservation sont également supprimés.
     * </p>
     *
     * @param id L'ID de la réservation à supprimer.
     * @return {@code true} si la suppression a réussi, {@code false} sinon.
     */
    @Override
    public boolean supprimerReservation(int id) {
        try {
            Reservation reservationAEnlever = null;
            for (Reservation r : this.reservationsEnregistrees) {
                if (r.getId() == id) {
                    reservationAEnlever = r;
                    break;
                }
            }
            if (reservationAEnlever == null) {
                return false;
            } else {
                for (Billet b : reservationAEnlever.getBillets()) {
                    this.billetsEnregistres.remove(b);
                }
                this.reservationsEnregistrees.remove(reservationAEnlever);
                return true;
            }
        } catch (Exception e) {
            return false;
        }
    }

    /**
     * Tente de connecter un utilisateur en vérifiant son adresse email et son mot de passe.
     * <p>
     * En cas de succès, l'utilisateur devient l'utilisateur connecté du modèle.
     * </p>
     *
     * @param email L'adresse email de l'utilisateur.
     * @param mdp Le mot de passe de l'utilisateur.
     * @return Un {@code ArrayList<Boolean>} contenant deux éléments :
     *         <ul>
     *           <li>Le premier élément est {@code true} en cas de succès de la connexion, {@code false} sinon.</li>
     *           <li>Le deuxième élément indique si l'utilisateur est un manager ({@code true}) ou non ({@code false}).</li>
     *         </ul>
     */
    @Override
    public ArrayList<Boolean> connecterUtilisateur(String email, String mdp) {
        ArrayList<Boolean> resConnexion = new ArrayList<Boolean>(Arrays.asList(false, false));
        try {
            for (Utilisateur u : utilisateursEnregistres) {
                if (u.getEmail().equals(email) && u.getMotDePasse().equals(mdp)) {
                    utilisateurConnecte = u;
                    resConnexion.set(0, true);
                    resConnexion.set(1, (u instanceof Manager));
                    return resConnexion;
                }
            }
            resConnexion.set(0, false);
            return resConnexion;
        } catch (Exception e) {
            resConnexion.set(0, false);
            return resConnexion;
        }
    }

    /**
     * Déconnecte l'utilisateur actuellement connecté.
     *
     * @return {@code true} si la déconnexion a réussi, {@code false} sinon.
     */
    @Override
    public boolean deconnecterUtilisateur() {
        try {
            if (this.utilisateurConnecte != null) {
                this.utilisateurConnecte = null;
                return true;
            }
            return false;
        } catch (Exception e) {
            return false;
        }
    }
}
